<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products, Customers & Orders Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
    <div class="container py-5">
        <h1 class="text-center mb-4">ðŸ›’ Products, Customers & Orders Management</h1>

        
        <div class="card mb-4 shadow">
            <div class="card-header bg-success text-white">Add Product</div>
            <div class="card-body">
                <form id="addProductForm" class="row g-3">
                    <div class="col-md-4"><input type="text" id="p_name" class="form-control" placeholder="Name"
                            required></div>
                    <div class="col-md-3"><input type="number" step="0.01" id="p_price" class="form-control"
                            placeholder="Price" required></div>
                    <div class="col-md-3"><input type="number" id="p_quantity" class="form-control"
                            placeholder="Quantity" required></div>
                    <div class="col-md-2 d-grid"><button type="submit" class="btn btn-primary">Add</button></div>
                </form>
            </div>
        </div>

        
        <div class="card mb-5 shadow">
            <div class="card-header bg-info text-white">Product List</div>
            <div class="card-body">
                <ul class="list-group" id="productList"></ul>
            </div>
        </div>

        
        <div class="card mb-4 shadow">
            <div class="card-header bg-primary text-white">Add Customer</div>
            <div class="card-body">
                <form id="addCustomerForm" class="row g-3">
                    <div class="col-md-4"><input type="text" id="c_name" class="form-control"
                            placeholder="Customer Name" required></div>
                    <div class="col-md-4"><input type="email" id="c_email" class="form-control" placeholder="Email"
                            required></div>
                    <div class="col-md-3"><input type="text" id="c_phone" class="form-control" placeholder="Phone"
                            required></div>
                    <div class="col-md-1 d-grid"><button type="submit" class="btn btn-success">Add</button></div>
                </form>
            </div>
        </div>

        
        <div class="card mb-5 shadow">
            <div class="card-header bg-secondary text-white">Customer List</div>
            <div class="card-body">
                <ul class="list-group" id="customerList"></ul>
            </div>
        </div>

       
        <div class="card mb-4 shadow">
            <div class="card-header bg-warning text-white">Create Order</div>
            <div class="card-body">
                
                <div id="orderAlert" class="mb-3"></div>

                <form id="createOrderForm">
                    <div class="mb-3">
                        <label for="orderCustomer" class="form-label">Select Customer</label>
                        <select id="orderCustomer" class="form-select" required></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Select Products & Quantity</label>
                        <div id="orderProducts"></div>
                    </div>

                   
                    <div class="mb-3">
                        <strong>Total: $<span id="orderTotal">0.00</span></strong>
                    </div>

                    <button type="submit" class="btn btn-success" id="createOrderBtn">Create Order</button>
                </form>
            </div>
        </div>

        
        <div class="card shadow">
            <div class="card-header bg-dark text-white">Orders List</div>
            <div class="card-body">
                <ul class="list-group" id="ordersList"></ul>
            </div>
        </div>
    </div>

    
    <div class="card shadow mb-4" id="orderDetailsCardWrapper">
        <div class="card-header bg-secondary text-white">Order Details</div>
        <div class="card-body">
            <div id="orderDetails">
                <p class="text-muted">Select an order (press "View Details") to see items here or in the modal.</p>
            </div>
            <hr>
            <button class="btn btn-outline-primary" id="openOrderModalBtn" style="display:none;" data-bs-toggle="modal"
                data-bs-target="#orderDetailsModal">Open in Modal</button>
        </div>
    </div>

    
    <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Order Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>Order ID: <span id="modal-order-id"></span></h6>
                    <table class="table table-striped mt-3">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Line Total</th>
                            </tr>
                        </thead>
                        <tbody id="modal-order-items"></tbody>
                    </table>
                    <h5 class="text-end">Total: $<span id="modal-total">0.00</span></h5>
                </div>
            </div>
        </div>
    </div>

    <script>
        
        function money(n) {
            const num = Number(n) || 0;
            return num.toFixed(2);
        }

        function showOrderAlert(message, type = 'danger') {
            const div = document.getElementById('orderAlert');
            div.innerHTML = `<div class="alert alert-${type}" role="alert">${message}</div>`;
        }

        function clearOrderAlert() {
            document.getElementById('orderAlert').innerHTML = '';
        }

    
        async function fetchProducts() {
            const res = await fetch('/products');
            const products = await res.json();
            const list = document.getElementById('productList');
            list.innerHTML = '';
            products.forEach(p => {
                const li = document.createElement('li');
                li.className = "list-group-item d-flex justify-content-between align-items-center";
                li.innerHTML = `${p.name} - $${money(p.price)} (Stock: ${p.quantity})
        <span>
            <button class="btn btn-info btn-sm me-1" onclick="editProduct(${p.id})">Edit</button>
            <button class="btn btn-danger btn-sm" onclick="deleteProduct(${p.id})">Delete</button>
        </span>`;
                list.appendChild(li);
            });
    
            loadOrderForm();
        }

        document.getElementById('addProductForm').addEventListener('submit', async e => {
            e.preventDefault();
            const name = document.getElementById('p_name').value;
            const price = parseFloat(document.getElementById('p_price').value);
            const quantity = parseInt(document.getElementById('p_quantity').value);
            await fetch('/products', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, price, quantity }) });
            document.getElementById('addProductForm').reset();
            fetchProducts();
        });

        async function editProduct(id) {
            const res = await fetch('/products');
            const products = await res.json();
            const product = products.find(p => p.id === id);
            const name = prompt('New name:', product.name);
            const priceInput = prompt('New price:', product.price);
            const quantityInput = prompt('New quantity:', product.quantity);
            const updatedName = name !== null && name !== "" ? name : product.name;
            const updatedPrice = priceInput !== null && priceInput.trim() !== "" ? parseFloat(priceInput) : product.price;
            const updatedQuantity = quantityInput !== null && quantityInput.trim() !== "" ? parseInt(quantityInput) : product.quantity;
            await fetch(`/products/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: updatedName, price: updatedPrice, quantity: updatedQuantity }) });
            fetchProducts();
        }

        async function deleteProduct(id) { if (confirm('Are you sure?')) { await fetch(`/products/${id}`, { method: 'DELETE' }); fetchProducts(); } }

    
        async function fetchCustomers() {
            const res = await fetch('/customers');
            const customers = await res.json();
            const list = document.getElementById('customerList');
            list.innerHTML = '';
            customers.forEach(c => {
                const li = document.createElement('li');
                li.className = "list-group-item d-flex justify-content-between align-items-center";
                li.innerHTML = `${c.name} - ${c.email} (${c.phone})
        <span>
            <button class="btn btn-info btn-sm me-1" onclick="editCustomer(${c.id})">Edit</button>
            <button class="btn btn-danger btn-sm" onclick="deleteCustomer(${c.id})">Delete</button>
        </span>`;
                list.appendChild(li);
            });
    
            loadOrderForm();
        }

        document.getElementById('addCustomerForm').addEventListener('submit', async e => {
            e.preventDefault();
            const name = document.getElementById('c_name').value;
            const email = document.getElementById('c_email').value;
            const phone = document.getElementById('c_phone').value;
            await fetch('/customers', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, email, phone }) });
            document.getElementById('addCustomerForm').reset();
            fetchCustomers();
        });

        async function editCustomer(id) {
            const res = await fetch('/customers');
            const customers = await res.json();
            const customer = customers.find(c => c.id === id);
            const name = prompt('New name:', customer.name);
            const email = prompt('New email:', customer.email);
            const phone = prompt('New phone:', customer.phone);
            const updatedName = name !== null && name !== "" ? name : customer.name;
            const updatedEmail = email !== null && email !== "" ? email : customer.email;
            const updatedPhone = phone !== null && phone !== "" ? phone : customer.phone;
            await fetch(`/customers/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: updatedName, email: updatedEmail, phone: updatedPhone }) });
            fetchCustomers();
        }

        async function deleteCustomer(id) { if (confirm('Are you sure?')) { await fetch(`/customers/${id}`, { method: 'DELETE' }); fetchCustomers(); } }

    
        function updateOrderTotal() {
            let total = 0;
            document.querySelectorAll('#orderProducts .order-row').forEach(row => {
                const checkbox = row.querySelector('.prod-check');
                const qtyInput = row.querySelector('.qty-input');
                const price = parseFloat(row.dataset.price) || 0;
                const qty = parseInt(qtyInput.value) || 0;
                if (checkbox.checked && qty > 0) {
                    total += price * qty;
                }
            });
            document.getElementById('orderTotal').textContent = money(total);
            return total;
        }

        async function loadOrderForm() {
            clearOrderAlert();

    
            const custRes = await fetch('/customers');
            const customers = await custRes.json();
            const custSelect = document.getElementById('orderCustomer');
            custSelect.innerHTML = '';
            customers.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                custSelect.appendChild(opt);
            });

    
            const prodRes = await fetch('/products');
            const products = await prodRes.json();
            const prodDiv = document.getElementById('orderProducts');
            prodDiv.innerHTML = '';

            if (!products.length) {
                prodDiv.innerHTML = `<div class="text-muted">No products available.</div>`;
                document.getElementById('orderTotal').textContent = '0.00';
                return;
            }

            products.forEach(p => {
                const row = document.createElement('div');
                row.className = 'order-row row align-items-center mb-2';
                row.dataset.id = p.id;
                row.dataset.price = p.price;
                row.dataset.stock = p.quantity;

                row.innerHTML = `
                    <div class="col-auto">
                        <input type="checkbox" class="form-check-input prod-check" id="prod_${p.id}" data-id="${p.id}">
                    </div>
                    <div class="col">
                        <label for="prod_${p.id}" class="form-label mb-0">
                            ${p.name} - $${money(p.price)} (Stock: ${p.quantity})
                        </label>
                    </div>
                    <div class="col-auto">
                        <input type="number" min="0" max="${p.quantity}" value="0" class="form-control form-control-sm qty-input" style="width: 90px;" id="qty_${p.id}">
                    </div>
                `;

                   const checkbox = row.querySelector('.prod-check');
                const qtyInput = row.querySelector('.qty-input');

                checkbox.addEventListener('change', () => {
                    let qty = parseInt(qtyInput.value) || 0;
                    if (checkbox.checked && qty === 0) {
                        qtyInput.value = 1; 
                    }
                    if (!checkbox.checked) {
                        qtyInput.value = 0;
                    }
                    updateOrderTotal();
                });

                qtyInput.addEventListener('input', () => {
                    let val = parseInt(qtyInput.value);
                    const max = parseInt(qtyInput.max);
                    if (isNaN(val) || val < 0) val = 0;
                    if (val > max) val = max;
                    qtyInput.value = val;
                    checkbox.checked = val > 0;
                    updateOrderTotal();
                });

                prodDiv.appendChild(row);
            });

            updateOrderTotal();
        }

        document.getElementById('createOrderForm').addEventListener('submit', async e => {
            e.preventDefault();
            clearOrderAlert();

            const customer_id = parseInt(document.getElementById('orderCustomer').value);
            const selectedProducts = [];

            document.querySelectorAll('#orderProducts .order-row').forEach(row => {
                const checkbox = row.querySelector('.prod-check');
                const qtyInput = row.querySelector('.qty-input');
                const qty = parseInt(qtyInput.value) || 0;
                const stock = parseInt(row.dataset.stock) || 0;
                const prodId = parseInt(row.dataset.id);

                if (checkbox.checked && qty > 0) {
                    if (qty > stock) {
                        showOrderAlert(`Quantity exceeds stock for product #${prodId}.`, 'danger');
                        return;
                    }
                    selectedProducts.push({ product_id: prodId, quantity: qty });
                }
            });

            if (selectedProducts.length === 0) {
                showOrderAlert('Please select at least one product with quantity > 0.', 'warning');
                return;
            }

            const btn = document.getElementById('createOrderBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Creating...';

            try {
                const res = await fetch('/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customer_id, products: selectedProducts })
                });

                const data = await res.json().catch(() => ({}));

                if (res.ok) {
                    showOrderAlert(`Order created successfully! Order ID: ${data.order_id}`, 'success');
                    
                    await fetchOrders();
                    await loadOrderForm();
                } else {
                    const msg = data && data.error ? data.error : 'Failed to create order.';
                    showOrderAlert(msg, 'danger');
                }
            } catch (err) {
                showOrderAlert('Network error. Please try again.', 'danger');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });

        async function fetchOrders() {
            const res = await fetch('/orders');
            const orders = await res.json();
            const list = document.getElementById('ordersList');
            list.innerHTML = '';
            orders.forEach(o => {
                const li = document.createElement('li');
                li.className = "list-group-item";
                li.textContent = `Order #${o.id} | Customer: ${o.name} | Total: $${money(o.total)} | Date: ${o.order_date}`;
                list.appendChild(li);
            });
        }

        function money(n) { return (Number(n) || 0).toFixed(2); }

        
        function renderOrderDetailsInline(data) {
            const el = document.getElementById('orderDetails');
            if (!data || !data.items) {
                el.innerHTML = '<p class="text-muted">No details available.</p>';
                return;
            }

            let html = `<h5>Order #${data.order_id}</h5>
                <p><strong>Total:</strong> $${money(data.total)}</p>
                <div class="table-responsive">
                <table class="table table-bordered mb-0">
                  <thead>
                    <tr>
                      <th>Product ID</th><th>Name</th><th>Qty</th><th>Price</th><th>Line Total</th>
                    </tr>
                  </thead>
                  <tbody>`;

            data.items.forEach(it => {
                html += `<tr>
        <td>${it.product_id}</td>
        <td>${it.name}</td>
        <td>${it.quantity}</td>
        <td>$${money(it.price)}</td>
        <td>$${money(it.line_total)}</td>
      </tr>`;
            });

            html += `</tbody></table></div>`;
            el.innerHTML = html;

            
            document.getElementById('modal-order-id').textContent = data.order_id;
            document.getElementById('modal-total').textContent = money(data.total);
            const tbody = document.getElementById('modal-order-items');
            tbody.innerHTML = '';
            data.items.forEach(it => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${it.name}</td><td>${it.quantity}</td><td>$${money(it.price)}</td><td>$${money(it.line_total)}</td>`;
                tbody.appendChild(tr);
            });

        
            document.getElementById('openOrderModalBtn').style.display = 'inline-block';
        }

        
        async function viewOrderDetails(order_id) {
            try {
                const res = await fetch(`/orders/${order_id}`);
                if (!res.ok) {
                    const err = await res.json().catch(() => ({ error: 'Unknown error' }));
                    document.getElementById('orderDetails').innerHTML = `<div class="alert alert-danger">Failed to load order: ${err.error || res.statusText}</div>`;
                    return;
                }
                const data = await res.json();
                renderOrderDetailsInline(data);
            } catch (e) {
                document.getElementById('orderDetails').innerHTML = `<div class="alert alert-danger">Network error. Try again.</div>`;
                console.error(e);
            }
        }

        async function fetchOrders() {
            const res = await fetch('/orders');
            const orders = await res.json();
            const list = document.getElementById('ordersList');
            list.innerHTML = '';
            orders.forEach(o => {
                const li = document.createElement('li');
                li.className = "list-group-item d-flex justify-content-between align-items-center";

                li.innerHTML = `
          <div>
            Order #${o.id} | Customer: ${o.name} | Total: $${money(o.total)} | Date: ${o.order_date}
          </div>
          <button class="btn btn-sm btn-info" onclick="viewOrderDetails(${o.id})">View Details</button>
        `;
                list.appendChild(li);
            });
        }


        fetchProducts();
        fetchCustomers();
        loadOrderForm();
        fetchOrders();
    </script>
</body>

</html>

